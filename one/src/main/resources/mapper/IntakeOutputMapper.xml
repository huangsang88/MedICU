<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="icu.one.mapper.IntakeOutputMapper">

    <resultMap id="IntakeOutputResultMap" type="icu.one.entity.IntakeOutput">
        <id column="record_id" property="recordId"/>
        <result column="patient_id" property="patientId"/>
        <result column="record_time" property="recordTime"/>
        <result column="type" property="type"/>
        <result column="category" property="category"/>
        <result column="volume_ml" property="volumeMl"/>
        <result column="description" property="description"/>
        <result column="shift_type" property="shiftType"/>
        <result column="nurse_id" property="nurseId"/>
        <result column="created_time" property="createdTime"/>
    </resultMap>

    <!-- 查询24小时出入量平衡 -->
    <select id="get24HourBalance" resultType="map">
        SELECT 
            SUM(CASE WHEN type = '摄入' THEN volume_ml ELSE 0 END) as total_intake,
            SUM(CASE WHEN type = '排出' THEN volume_ml ELSE 0 END) as total_output,
            (SUM(CASE WHEN type = '摄入' THEN volume_ml ELSE 0 END) - 
             SUM(CASE WHEN type = '排出' THEN volume_ml ELSE 0 END)) as balance
        FROM intake_output 
        WHERE patient_id = #{patientId} 
        AND record_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
    </select>

    <!-- 查询24小时出入量分类总结 -->
    <select id="get24HourSummary" resultType="map">
        SELECT 
            type,
            category,
            SUM(volume_ml) as total_volume
        FROM intake_output 
        WHERE patient_id = #{patientId} 
        AND record_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
        GROUP BY type, category
        ORDER BY type, category
    </select>

    <!-- 查询班次内出入量 -->
    <select id="getShiftBalance" resultType="map">
        SELECT 
            SUM(CASE WHEN type = '摄入' THEN volume_ml ELSE 0 END) as total_intake,
            SUM(CASE WHEN type = '排出' THEN volume_ml ELSE 0 END) as total_output,
            (SUM(CASE WHEN type = '摄入' THEN volume_ml ELSE 0 END) - 
             SUM(CASE WHEN type = '排出' THEN volume_ml ELSE 0 END)) as balance
        FROM intake_output 
        WHERE patient_id = #{patientId} 
        AND shift_type = #{shiftType}
        AND DATE(record_time) = CURDATE()
    </select>

    <!-- 查询出入量趋势 -->
    <select id="getIntakeOutputTrend" resultMap="IntakeOutputResultMap">
        SELECT * FROM intake_output 
        WHERE patient_id = #{patientId} 
        AND record_time BETWEEN #{startTime} AND #{endTime}
        ORDER BY record_time
    </select>

    <!-- 添加出入量记录 -->
    <insert id="addIntakeOutput" useGeneratedKeys="true" keyProperty="recordId">
        INSERT INTO intake_output(
            patient_id, record_time, type, category,
            volume_ml, description, shift_type, nurse_id
        ) VALUES (
            #{patientId}, #{recordTime}, #{type}, #{category},
            #{volumeMl}, #{description}, #{shiftType}, #{nurseId}
        )
    </insert>

    <!-- 批量添加出入量记录 -->
    <insert id="batchAddIntakeOutput">
        INSERT INTO intake_output(
            patient_id, record_time, type, category,
            volume_ml, description, shift_type, nurse_id
        ) VALUES 
        <foreach collection="list" item="record" separator=",">
            (
                #{record.patientId}, #{record.recordTime}, #{record.type}, #{record.category},
                #{record.volumeMl}, #{record.description}, #{record.shiftType}, #{record.nurseId}
            )
        </foreach>
    </insert>

</mapper>
