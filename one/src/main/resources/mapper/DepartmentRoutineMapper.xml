<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="icu.one.mapper.DepartmentRoutineMapper">

    <!-- 查询所有科室常规配置 -->
    <select id="selectAllRoutines">
        SELECT 
            dr.*,
            tt.task_name,
            tt.task_type,
            tt.frequency,
            tt.default_assignee_role
        FROM department_routines dr
        LEFT JOIN task_templates tt ON dr.template_id = tt.template_id
        WHERE dr.is_active = TRUE
        ORDER BY dr.department, dr.routine_name
    </select>

    <!-- 根据ID查询科室常规配置 -->
    <select id="getRoutineById">
        SELECT 
            dr.*,
            tt.task_name,
            tt.task_type,
            tt.frequency,
            tt.default_assignee_role
        FROM department_routines dr
        LEFT JOIN task_templates tt ON dr.template_id = tt.template_id
        WHERE dr.routine_id = #{routineId}
    </select>

    <!-- 根据科室查询常规配置 -->
    <select id="getRoutinesByDepartment">
        SELECT 
            dr.*,
            tt.task_name,
            tt.task_type,
            tt.frequency,
            tt.default_assignee_role
        FROM department_routines dr
        LEFT JOIN task_templates tt ON dr.template_id = tt.template_id
        WHERE dr.department = #{department} AND dr.is_active = TRUE
        ORDER BY dr.trigger_event, dr.routine_name
    </select>

    <!-- 根据触发事件查询配置 -->
    <select id="getRoutinesByTriggerEvent" >
        SELECT 
            dr.*,
            tt.task_name,
            tt.task_type,
            tt.frequency,
            tt.default_assignee_role
        FROM department_routines dr
        LEFT JOIN task_templates tt ON dr.template_id = tt.template_id
        WHERE dr.trigger_event = #{triggerEvent} AND dr.is_active = TRUE
        ORDER BY dr.department
    </select>

    <!-- 添加科室常规配置 -->
    <insert id="addDepartmentRoutine" useGeneratedKeys="true" keyProperty="routineId">
        INSERT INTO department_routines(
            department, routine_name, description, trigger_event,
            trigger_time, delay_minutes, template_id, is_active, created_by
        ) VALUES (
            #{department}, #{routineName}, #{description}, #{triggerEvent},
            #{triggerTime}, #{delayMinutes}, #{templateId}, #{isActive}, #{createdBy}
        )
    </insert>

    <!-- 更新科室常规配置 -->
    <update id="updateDepartmentRoutine">
        UPDATE department_routines 
        SET department = #{department},
            routine_name = #{routineName},
            description = #{description},
            trigger_event = #{triggerEvent},
            trigger_time = #{triggerTime},
            delay_minutes = #{delayMinutes},
            template_id = #{templateId},
            is_active = #{isActive},
            created_by = #{createdBy}
        WHERE routine_id = #{routineId}
    </update>

    <!-- 启用/禁用常规配置 -->
    <update id="toggleRoutineStatus">
        UPDATE department_routines 
        SET is_active = #{isActive}
        WHERE routine_id = #{routineId}
    </update>

    <!-- 删除科室常规配置 -->
    <delete id="deleteDepartmentRoutine">
        DELETE FROM department_routines WHERE routine_id = #{routineId}
    </delete>

    <!-- 根据患者入院事件生成任务 -->
    <select id="getRoutinesForPatientAdmission" >
        SELECT 
            dr.*,
            tt.task_name,
            tt.task_type,
            tt.frequency,
            tt.default_assignee_role,
            tt.estimated_duration
        FROM department_routines dr
        LEFT JOIN task_templates tt ON dr.template_id = tt.template_id
        WHERE dr.trigger_event = '患者入院' 
            AND dr.is_active = TRUE 
            AND tt.is_active = TRUE
            AND (dr.department = #{department} OR dr.department IS NULL)
    </select>

    <!-- 统计各科室常规配置数量 -->
    <select id="getRoutineStatistics" >
        SELECT 
            department,
            trigger_event,
            COUNT(*) as count,
            SUM(CASE WHEN is_active = TRUE THEN 1 ELSE 0 END) as active_count
        FROM department_routines 
        GROUP BY department, trigger_event
        ORDER BY department, trigger_event
    </select>

</mapper>
